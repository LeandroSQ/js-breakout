(()=>{var j=Math.pow;var u=(r,t,e)=>new Promise((i,s)=>{var n=d=>{try{c(e.next(d))}catch(x){s(x)}},o=d=>{try{c(e.throw(d))}catch(x){s(x)}},c=d=>d.done?i(d.value):Promise.resolve(d.value).then(n,o);c((e=e.apply(r,t)).next())});window.addLoadEventListener=function(r){let t=!1,e=()=>{t||(t=!0,r())};window.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e),document.addEventListener("load",e),window.addEventListener("ready",e),setTimeout(e,1e3)};window.addVisibilityChangeEventListener=function(r){let t=["webkit","moz","ms",""],e=!1,i=()=>{if(e)return;e=!0;let s=t.map(n=>n&&n.length>0?`${n}Hidden`:"hidden").map(n=>document[n]).reduce((n,o)=>n||o,!1);setTimeout(()=>{r(!s),e=!1},0)};for(let s of t)document.addEventListener(`${s}visibilitychange`,i);document.onvisibilitychange=i};HTMLCanvasElement.prototype.screenshot=function(r="download.png"){let t=document.createElement("a");t.download=r,t.href=this.toDataURL("image/png;base64"),t.style.visibility="hidden",t.style.display="none",document.body.appendChild(t),setTimeout(()=>{t.click(),document.body.removeChild(t)},100)};String.prototype.toCamelCase=function(){return this.replace("--","").replace(/-./g,r=>r[1].toUpperCase()).trim()};Array.prototype.remove=function(r){let t=this.indexOf(r);return t!=-1?(this.splice(t,1),!0):!1};Array.prototype.appendArray=function(r){if(!!r)for(let t=0;t<r.length;t++)this.push(r[t])};Math.clamp=function(r,t,e){return Math.min(Math.max(r,t),e)};Math.average=function(...r){return r.reduce((t,e)=>t+e,0)/r.length};Math.distance=function(r,t,e,i){return Math.sqrt(Math.pow(e-r,2)+Math.pow(i-t,2))};Math.randomInt=function(r,t){return Math.floor(Math.random()*(t-r+1))+r};Math.lerp=function(r,t,e){let i=t-r;return i>e?r+e:i<-e?r-e:r+i};Math.oscilate=function(r,t,e,i){let s=2*Math.PI*t,n=i-e,c=(Math.sin(s*r)+1)/2;return e+c*n};CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)};CanvasRenderingContext2D.prototype.line=function(r,t,e,i){this.beginPath(),this.moveTo(r,t),this.lineTo(e,i),this.stroke()};CanvasRenderingContext2D.prototype.fillTextCentered=function(r,t,e){let i=this.measureText(r);this.fillText(r,t-i.width/2,e)};Promise.delay=function(r){return new Promise((t,e)=>{setTimeout(t,r)})};var f=class{static logColoredText(t,e,i,...s){console[t].call(console,`%c${t.toUpperCase()} %c[${e}]`,`font-weight: bold; color: ${i};`,"font-weight: bold; color: gray",...s)}static info(t,...e){this.logColoredText("info",t,"turquoise",...e)}static warn(t,...e){this.logColoredText("warn",t,"yellow",...e)}static error(t,...e){this.logColoredText("error",t,"red",...e)}static debug(t,...e){}};var a=class{constructor(t,e=void 0){this.x=t,e===void 0?this.y=t:this.y=e}dot(t){return this.x*t.x+this.y*t.y}add(t){return new a(this.x+t.x,this.y+t.y)}subtract(t){return new a(this.x-t.x,this.y-t.y)}multiply(t){return new a(this.x*t,this.y*t)}divide(t){return new a(this.x/t,this.y/t)}normalize(){let t=this.length;return new a(this.x/t,this.y/t)}clone(){return new a(this.x,this.y)}static distance(t,e){return Math.sqrt(j(t.x-e.x,2)+j(t.y-e.y,2))}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static get zero(){return new a(0,0)}toString(){return`{ ${this.x}, ${this.y} }`}};var p=class{constructor(t,e,i,s){this.x=t;this.y=e;this.width=i;this.height=s}translate(t){return new p(this.x+t.x,this.y+t.y,this.width,this.height)}contains(t,e=void 0){if(t instanceof a&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y;if(t instanceof p&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height;if(typeof t=="number"&&typeof e=="number")return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height;throw new Error("Invalid arguments")}intersects(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}intersection(t){let e=Math.max(this.x,t.x),i=Math.max(this.y,t.y),s=Math.min(this.x+this.width,t.x+t.width)-e,n=Math.min(this.y+this.height,t.y+t.height)-i;return new p(e,i,s,n)}get size(){return new a(this.width,this.height)}get position(){return new a(this.x,this.y)}set position(t){this.x=t.x,this.y=t.y}get center(){return new a(this.x+this.width/2,this.y+this.height/2)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}clone(){return new p(this.x,this.y,this.width,this.height)}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}toString(){return`{ x: ${this.x}, y: ${this.y}, width: ${this.width}, height: ${this.height} }`}};var k=class{constructor(t=void 0){this.element=document.createElement("canvas");this.virtualWidth=0;this.virtualHeight=0;this.drawRatio=1;this.overrideRatio=void 0;t&&(this.element.id=t);let e=this.element.getContext("2d");if(!e)throw new Error("Could not get context of canvas");this.context=e,this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.element.oncontextmenu=()=>!1}get backingStoreRatio(){return this.overrideRatio||this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1}get devicePixelRation(){return this.overrideRatio||window.devicePixelRatio||1}getDrawRatio(t,e){return e/t}setSize(t,e){this.drawRatio=this.getDrawRatio(this.backingStoreRatio,this.devicePixelRation),this.backingStoreRatio!==this.devicePixelRation?(this.element.width=t*this.drawRatio,this.element.height=e*this.drawRatio,this.element.style.width=`${t}px`,this.element.style.minWidth=`${t}px`,this.element.style.height=`${e}px`,this.element.style.minHeight=`${e}px`):(this.element.width=t,this.element.height=e,this.element.style.width="",this.element.style.height=""),this.context.scale(this.drawRatio,this.drawRatio),this.virtualWidth=t,this.virtualHeight=e}clear(){this.context.clearRect(0,0,this.element.width,this.element.height)}drawTo(t,e,i){i.save(),i.scale(1/this.drawRatio,1/this.drawRatio),i.drawImage(this.element,t,e),i.restore()}attachToElement(t){t.appendChild(this.element)}get width(){return this.virtualWidth||this.element.width}get height(){return this.virtualHeight||this.element.height}get bounds(){return new p(0,0,this.width,this.height)}get size(){return{width:this.width,height:this.height}}};var l=class{static isKeyDown(...t){return t.some(e=>this.keys[e])}static isKeyJustPressed(...t){return t.some(e=>this.keysJustPressed[e])}static onKeyDown(t){this.keys[t.key]=!0,this.keysJustPressed[t.key]=!0,this.isDirty=!0,this.anyInput=!0}static onKeyUp(t){this.keys[t.key]=!1,delete this.keysJustPressed[t.key],this.isDirty=!0}static isMouseButtonDown(...t){return t.some(e=>this.mouseButtons[e])}static isMouseButtonJustPressed(...t){return t.some(e=>this.mouseButtonsJustPressed[e])}static isMouseButtonJustReleased(...t){return t.some(e=>this.mouseButtonsJustReleased[e])}static onMouseMove(t){var e,i,s,n;this.mouseDelta.x=t.movementX,this.mouseDelta.y=t.movementY,this.mouse.x=t.clientX-((i=(e=t.target)==null?void 0:e.offsetLeft)!=null?i:0),this.mouse.y=t.clientY-((n=(s=t.target)==null?void 0:s.offsetTop)!=null?n:0),this.isDirty=!0}static onMouseDown(t){this.mouseButtons[t.button]=!0,this.mouseButtonsJustPressed[t.button]=!0,this.isDirty=!0,this.anyInput=!0}static onMouseUp(t){this.mouseButtons[t.button]=!1,this.mouseButtonsJustReleased[t.button]=!0,this.isDirty=!0}static onPointerDown(t,e){console.log("Pointer down",e),this.mouseButtons[e.button]=!0,this.mouseButtonsJustPressed[e.button]=!0,t.setPointerCapture(e.pointerId),this.isDirty=!0,this.anyInput=!0}static onPointerUp(t,e){console.log("Pointer up",e),this.mouseButtons[e.button]=!1,this.mouseButtonsJustReleased[e.button]=!0,t.releasePointerCapture(e.pointerId),this.isDirty=!0}static setup(t){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.mouse.x=window.innerWidth/2,this.mouse.y=window.innerHeight/2,t.canvas.element.addEventListener("click",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousemove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousedown",this.onMouseDown.bind(this)),t.canvas.element.addEventListener("mouseup",this.onMouseUp.bind(this)),t.canvas.element.addEventListener("pointermove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("pointerdown",this.onPointerDown.bind(this,t.canvas.element)),t.canvas.element.addEventListener("pointerup",this.onPointerUp.bind(this,t.canvas.element))}static update(){this.keysJustPressed={},this.mouseButtonsJustPressed={},this.mouseButtonsJustReleased={},this.mouseDelta.x=0,this.mouseDelta.y=0,this.isDirty=!1,this.anyInput=!1}};l.isDirty=!1,l.anyInput=!1,l.keys={},l.keysJustPressed={},l.mouse=a.zero,l.mouseDelta=a.zero,l.mouseButtons={},l.mouseButtonsJustPressed={},l.mouseButtonsJustReleased={};var b=class{static alpha(t,e){let i=t;i.startsWith("#")&&(i=i.slice(1)),i.length===3&&(i=i.replace(/./g,"$&$&"));let s=Math.round(e*255).toString(16).padStart(2,"0");return`#${i}${s}`}static interpolate(t,e,i){let s=`0x${t.trim().slice(1)}`,n=`0x${e.trim().slice(1)}`;s.length<5&&(s=s.replace(/./g,"$&$&")),n.length<5&&(n=n.replace(/./g,"$&$&"));let o=parseInt(s,16),c=parseInt(n,16),d=o>>16,x=o>>8&255,H=o&255,S=c>>16,R=c>>8&255,V=c&255,U=Math.round(d+(S-d)*i),$=Math.round(x+(R-x)*i),N=Math.round(H+(V-H)*i);return`#${(16777216+(U<<16)+($<<8)+N).toString(16).slice(1)}`}static isColorLight(t){let e=`0x${t.trim().slice(1)}`;e.length<5&&(e=e.replace(/./g,"$&$&"));let i=parseInt(e,16),s=i>>16,n=i>>8&255,o=i&255;return Math.sqrt(.299*(s*s)+.587*(n*n)+.114*(o*o))>127.5}};var Q=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.strokeStyle=this.color,t.lineWidth=1,t.strokeRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},tt=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.fillStyle=this.color,t.fillRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},et=class{constructor(t,e,i,s){this.start=t;this.end=e;this.color=i;this.thickness=s}render(t){t.strokeStyle=this.color,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.stroke()}},it=class{constructor(t,e,i){this.center=t;this.radius=e;this.color=i}render(t){t.fillStyle=this.color,t.lineWidth=1,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,Math.PI*2),t.fill()}},st=class{constructor(t,e,i,s){this.text=t;this.position=e;this.color=i;this.alignment=s}render(t){t.save(),t.fillStyle=this.color,t.font="12px Arial",t.textAlign=this.alignment,t.fillText(this.text,this.position.x,this.position.y),t.restore()}},nt=class{constructor(t,e,i){this.origin=t;this.vector=e;this.color=i;this.ARROWHEAD_LENGTH=10;this.ARROWHEAD_ANGLE=Math.PI/6;this.MIN_LENGTH=1;this.MAX_LENGTH=100}render(t){let e=this.vector.length;if(e<this.MIN_LENGTH)return;e>this.MAX_LENGTH&&(this.vector=this.vector.normalize().multiply(this.MAX_LENGTH),e=this.MAX_LENGTH);let i=(e-this.MIN_LENGTH)/(this.MAX_LENGTH-this.MIN_LENGTH),s=b.alpha(this.color,i);t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1.5,t.lineCap="round",t.beginPath(),t.moveTo(this.origin.x,this.origin.y),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.stroke();let n=10,o=Math.PI/6,c=Math.atan2(this.vector.y,this.vector.x);t.beginPath(),t.moveTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.lineTo(this.origin.x+this.vector.x-n*Math.cos(c-o),this.origin.y+this.vector.y-n*Math.sin(c-o)),t.lineTo(this.origin.x+this.vector.x-n*Math.cos(c+o),this.origin.y+this.vector.y-n*Math.sin(c+o)),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.fill()}},T=class{static render(t){}static clear(){}static rect(t,e="#fff"){}static outline(t,e="#fff"){}static line(t,e,i="#fff",s=1){}static circle(t,e,i="#fff"){}static text(t,e,i="#fff",s="left"){}static arrow(t,e,i="#fff"){}},m=T;m.list=[];var g=class{static set(t){this.current=t}static apply(){document.body.style.cursor=this.current}static reset(){this.current="default"}};g.current="default";var h=class{static get isDark(){return window.matchMedia("(prefers-color-scheme: dark)").matches}static setup(){return u(this,null,function*(){h.loadVariables(),h.observeChanges()})}static loadVariables(){let t=["--background","--foreground","--secondary","--container-background","--container-border","--container-shadow"];f.info("Theme",`Setting up theme, loading ${t.length} variables...`),console.groupCollapsed("Loading theme variables");let e=getComputedStyle(document.body);for(let i of t){let s=e.getPropertyValue(i),n=i.toString().toCamelCase();h[n]=s,console.log(`%c${n}`,`color: ${b.isColorLight(s)?"#212121":"#eee"}; background-color: ${s}`)}console.groupEnd()}static observeChanges(){let t=window.matchMedia("(prefers-color-scheme: dark)");t.addEventListener("change",()=>{f.info("Theme",`Changed theme to ${t.matches?"dark":"light"}`),h.loadVariables()})}};var y="'Pixelify Sans', sans-serif";var _t=10*3,rt=440,ht=75,O=.2,lt=220,ct=110,ut=500;var C=class{static setup(){return u(this,null,function*(){this.context=new AudioContext,this.master=this.context.createGain(),this.master.connect(this.context.destination),this.master.gain.setValueAtTime(O,this.context.currentTime)})}static resume(){return u(this,null,function*(){if(this.context.state==="suspended"||this.context.state==="interrupted")yield this.context.resume();else if(this.context.state==="closed")return yield this.setup(),!0;return!1})}static play(t,e,i=0){return u(this,null,function*(){if(yield this.resume())return;let s=this.context.createGain();s.connect(this.master);let n=this.context.createStereoPanner();n.connect(s),n.pan.setValueAtTime(i,this.context.currentTime);let o=this.context.createOscillator();o.connect(n),o.type="square",o.frequency.setValueAtTime(t,this.context.currentTime);let c=.01,d=.1,x=.4,H=.1,S=this.context.currentTime,R=e/1e3,V=S+c*R,U=V+d*R,$=U+x*R,N=$+H*R;s.gain.setValueAtTime(0,S),s.gain.linearRampToValueAtTime(O,V),s.gain.linearRampToValueAtTime(.8*O,U),s.gain.linearRampToValueAtTime(.8*O,$),s.gain.linearRampToValueAtTime(0,N),o.addEventListener("ended",()=>{o.disconnect(),n.disconnect(),s.disconnect()}),o.start(S),o.stop(N)})}static playWithDurationVariance(t,e=0){return u(this,null,function*(){let i=ht*(1+Math.random()*.8-.4);this.play(t,i,e)})}};var G=class{static setup(){return u(this,null,function*(){let t=`${48}pt ${y}`;document.fonts.check(t)||(yield document.fonts.load(t))})}};var M={DIFFICULTY:1};var L=class{constructor(t){this.main=t;this.bounds=new p(0,0,10*2,10*2);this.velocity=new a(0,0);this.bounds.position=a.zero,this.velocity=a.zero,this.reset()}reset(){this.bounds.x=this.main.canvas.width/2-this.bounds.width/2,this.bounds.y=this.main.canvas.height/2-this.bounds.height/2+15*2,this.velocity=a.zero}bounceOffScreenEdges(){let t=this.main.canvas.size;this.bounds.x<0&&this.velocity.x<0?(this.bounds.x=0,this.velocity.x*=-1):this.bounds.x+this.bounds.width>t.width&&this.velocity.x>0&&(this.bounds.x=t.width-this.bounds.width,this.velocity.x*=-1),this.bounds.y<0&&this.velocity.y<0?(this.bounds.y=0,this.velocity.y*=-1):this.bounds.y+this.bounds.height>t.height&&this.velocity.y>0&&this.main.onBallBounceOffBottom()}bounceOffBlocks(){let t=this.main.blocks;for(let e=t.length-1;e>=0;e--){let i=t[e];if(this.bounds.intersects(i.bounds)){let s=Math.abs(this.bounds.bottom-i.bounds.y),n=Math.abs(this.bounds.y-i.bounds.bottom),o=Math.abs(this.bounds.right-i.bounds.x),c=Math.abs(this.bounds.x-i.bounds.right),d=Math.min(s,n,o,c);d===s||d===n?(this.velocity.y*=-1,this.bounds.y+=d===s?-10:10):(this.velocity.x*=-1,this.bounds.x+=d===o?-10:10),t.splice(e,1),this.main.onBallBounceOffBlock()}}}accelerateToRandomDirection(){this.velocity=new a(Math.random()<.5?-500:500,500)}bounceOffPaddle(){this.bounds.intersects(this.main.paddle.bounds)&&this.velocity.y>0&&(this.velocity.y*=-1,this.main.onBallBounceOffPaddle())}update(t){this.bounds.x+=this.velocity.x*M.DIFFICULTY*t,this.bounds.y+=this.velocity.y*M.DIFFICULTY*t,this.bounceOffScreenEdges(),this.bounceOffPaddle(),this.bounceOffBlocks()}render(t){t.beginPath(),this.main.isInPreparationTime?t.fillStyle=b.alpha(h.foreground,Math.sin(this.main.preparationTimer*(Math.PI*2)*1.2)*.25+.75):t.fillStyle=h.foreground,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var B=class{constructor(t){this.bounds=new p(0,0,100,20);this.score=0;this.bounds.position=new a(t.width/2-100/2,t.height-20-15)}render(t){t.fillStyle=h.foreground,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var W=class extends B{constructor(e){super(e.canvas.size);this.main=e}moveTo(e,i,s=1){let n=e*840.34*M.DIFFICULTY*s;this.bounds.x=Math.clamp(Math.lerp(this.bounds.x,i,n),0,this.main.canvas.width-this.bounds.width)}moveToCenter(e){m.text("moveToCenter",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.canvas.width/2-this.bounds.width/2;this.moveTo(e,i)}chaseBall(e){m.text("chaseBall",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.ball.bounds.x,s=Math.abs(this.main.canvas.width-this.bounds.width),n=Math.abs(this.bounds.x-this.main.ball.bounds.x)/s;this.moveTo(e,i,n)}predictBallTrajectory(e){m.text("predictBallTrajectory",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.ball.bounds.y+this.main.ball.bounds.height,s=(this.bounds.y-i)/500,n=this.main.ball.bounds.x+this.main.ball.velocity.x*s;for(let c=0;(n<0||n+this.main.ball.bounds.width>this.main.canvas.width)&&c<10;c++)n<0&&(m.circle(new a(n+this.main.ball.bounds.width,i-this.main.ball.bounds.height/2),this.main.ball.bounds.height/2,"rgba(255, 0, 0, 0.25)"),n=-n),n+this.main.ball.bounds.width>this.main.canvas.width&&(m.circle(new a(this.main.canvas.width-this.main.ball.bounds.width,i-this.main.ball.bounds.height/2),this.main.ball.bounds.height/2,"rgba(255, 0, 0, 0.25)"),n=this.main.canvas.width-this.main.ball.bounds.width-(n-this.main.canvas.width+this.main.ball.bounds.width));let o=n-this.bounds.width/2;this.moveTo(e,o),m.circle(this.bounds.center,5,"red"),m.circle(new a(n,i),5,"green"),m.line(this.main.ball.bounds.center,new a(n,this.bounds.y),"green")}update(e){this.main.isInPreparationTime?this.moveToCenter(e):this.main.ball.bounds.y<this.main.canvas.height/3||this.main.ball.velocity.y<0?this.chaseBall(e):this.predictBallTrajectory(e)}};var D=class{setup(){return Promise.resolve()}preRender(t){}render(t){}};var Y=class extends D{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return u(this,null,function*(){this.main.ball.velocity=a.zero,g.set("pointer")})}update(e){return u(this,null,function*(){this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,l.anyInput&&this.main.setState(new A(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(1-this.dimTimer,4),s=h.isDark?.15:.25;e.globalAlpha=s+i*(1-s),e.filter="blur(5px)"}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${y}`,e.fillStyle=h.foreground,e.shadowColor=h.containerShadow,e.shadowBlur=10*this.dimTimer,e.shadowOffsetY=2.5,e.fillTextCentered("You won!",this.width/2,this.height/2-48),e.font=`${48/2}pt ${y}`,e.fillStyle=b.alpha(h.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to restart",this.width/2,this.height/2),e.restore()}};var J=class extends B{constructor(e){super(e.canvas.size);this.main=e}update(e){l.mouseDelta.x!==0?(this.bounds.x+=l.mouse.x-this.bounds.width/2-this.bounds.x,this.bounds.x<0?this.bounds.x=0:this.bounds.x+this.bounds.width>this.main.canvas.width&&(this.bounds.x=this.main.canvas.width-this.bounds.width)):(l.isKeyDown("ArrowLeft")&&(this.bounds.x-=840.34*e,this.bounds.x<0&&(this.bounds.x=0)),l.isKeyDown("ArrowRight")&&(this.bounds.x+=840.34*e,this.bounds.x+this.bounds.width>this.main.canvas.width&&(this.bounds.x=this.main.canvas.width-this.bounds.width)))}};var K=class extends D{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return u(this,null,function*(){g.set("pointer")})}update(e){return u(this,null,function*(){this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,l.anyInput&&this.main.setState(new A(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(1-this.dimTimer,4),s=h.isDark?.15:.25;e.globalAlpha=s+i*(1-s),e.filter=`blur(${i.toFixed(1)}px)`}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${y}`,e.fillStyle=h.foreground,e.shadowColor=h.containerShadow,e.shadowBlur=10*Math.pow(1-this.dimTimer,4),e.shadowOffsetY=2.5,e.fillTextCentered("Game over!",this.width/2,this.height/2-48),e.font=`${48/2}pt ${y}`,e.fillStyle=b.alpha(h.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to restart",this.width/2,this.height/2),e.restore()}};var A=class extends D{constructor(e){super();this.main=e}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return u(this,null,function*(){f.debug("StatePlay","Setting up..."),this.main.ball=new L(this.main),this.main.paddle=new J(this.main),this.main.generateBlocks(),this.main.reset(!0),g.set("none")})}update(e){return u(this,null,function*(){this.main.blocks.length<=0?this.main.setState(new Y(this.main)):this.main.lives<=0&&this.main.setState(new K(this.main)),this.main.updateEntities(e),this.invalidate()})}};var Z=class extends D{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return u(this,null,function*(){g.set("pointer"),this.main.ball=new L(this.main),this.main.paddle=new W(this.main),this.main.generateBlocks()})}update(e){return u(this,null,function*(){this.main.blocks.length<=0&&(this.main.reset(!0),this.main.generateBlocks()),this.main.updateEntities(e),this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,l.anyInput&&this.main.setState(new A(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(this.dimTimer,4),s=h.isDark?.15:.25;e.globalAlpha=s*i,e.filter=`blur(${i.toFixed(1)}px)`}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${y}`,e.fillStyle=h.foreground,e.shadowColor=h.containerShadow,e.shadowBlur=10*Math.pow(this.dimTimer,4),e.shadowOffsetY=2.5,e.fillTextCentered("Breakout",this.width/2,this.height/2-48),e.font=`${48/2}pt ${y}`,e.fillStyle=b.alpha(h.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to start",this.width/2,this.height/2),e.restore()}};var X=class{constructor(t,e,i){this.color=i;this.bounds=new p(t,e,60,22.5)}render(t){t.beginPath(),t.fillStyle=this.color,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var at=class{constructor(){this.canvas=new k("canvas");this.isDirty=!0;this.blocksBuffer=new k("block-buffer");this.isBlocksBufferDirty=!0;this.handleAnimationFrameRequest=-1;this.lastFrameTime=performance.now();this.state=new Z(this);this.globalTimer=0;this.blocks=[];this.preparationTimer=3;this.lives=3;this.lastTimer=0;this.audioPitch=0;this.timeSinceLastHit=0;f.info("Main","Starting up..."),this.attachHooks()}attachHooks(){f.info("Main","Attaching hooks..."),window.addLoadEventListener(this.onLoad.bind(this)),window.addVisibilityChangeEventListener(this.onVisibilityChange.bind(this)),window.addEventListener("resize",this.onResize.bind(this)),l.setup(this)}get isInPreparationTime(){return this.preparationTimer>0}generateBlocks(){this.blocks=[];let t=Math.floor((this.canvas.width-15*2-60*2)/(60+15)),e=Math.floor((this.canvas.height/2-15*2-22.5)/(22.5+15)),i=this.canvas.width/2-t*(60+15)/2+15/2,s=this.canvas.height/2-e*(22.5+15);for(let n=0;n<e;n++)for(let o=0;o<t;o++){let c=o*(60+15)+i,d=n*(22.5+15)+s,x=`oklch(from hsl(${n/e*100} 50% 50%) l c h)`;this.blocks.push(new X(c,d,x))}this.invalidateBlocksBuffer()}reset(t=!1){this.preparationTimer=3,t&&(this.lives=3),M.DIFFICULTY=1,this.ball.reset()}onLoad(){return u(this,null,function*(){f.debug("Main","Window loaded"),this.canvas.attachToElement(document.body),this.onResize(),yield h.setup(),yield C.setup(),yield G.setup(),yield this.state.setup(),this.requestNextFrame()})}onVisibilityChange(t){f.info("Main",`Window visibility changed to ${t?"visible":"hidden"}`),t?(this.invalidate(),this.requestNextFrame()):this.handleAnimationFrameRequest!=-1&&cancelAnimationFrame(this.handleAnimationFrameRequest)}onResize(){f.debug("Main","Window resized");let t=16/10,e=1200,i=e/t,s=this.canvas.size,n=window.innerWidth-15*4,o=window.innerHeight-15*4;o>i&&(o=i),n>e&&(n=e),n/o>t?n=o*t:o=n/t,this.canvas.setSize(n,o),this.blocksBuffer.setSize(n,o),this.invalidate(),this.invalidateBlocksBuffer()}onBallBounceOffPaddle(){C.playWithDurationVariance(rt),M.DIFFICULTY*=1.0075}onBallBounceOffBlock(){this.timeSinceLastHit=performance.now(),this.audioPitch+=.25;let t=Math.min(1,Math.max(-1,(this.ball.bounds.center.x-screen.width/2)/(screen.width/2))),e=lt*(1+this.audioPitch);C.playWithDurationVariance(e,t),M.DIFFICULTY*=1.0075,this.invalidateBlocksBuffer()}onBallBounceOffBottom(){this.lives--,this.reset(),C.playWithDurationVariance(rt)}setState(t){this.state=t,this.state.setup(),g.apply(),this.invalidate()}invalidate(){this.isDirty=!0}invalidateBlocksBuffer(){this.isBlocksBufferDirty=!0,this.isDirty=!0}requestNextFrame(){this.handleAnimationFrameRequest=requestAnimationFrame(this.loop.bind(this))}updateTimers(t,e){if(t-this.timeSinceLastHit>ut&&(this.audioPitch=0),this.ball.velocity.length===0){if(this.preparationTimer<=0?this.ball.accelerateToRandomDirection():this.preparationTimer-=e,Math.floor(this.preparationTimer)!==this.lastTimer){this.lastTimer=Math.floor(this.preparationTimer);let i=ct*(3-this.preparationTimer+1);C.playWithDurationVariance(i)}m.text(this.preparationTimer.toFixed(2),this.ball.bounds.center.add(new a(0,10*4)),"red","center")}}updateEntities(t){this.updateTimers(performance.now(),t);let e=8,i=t/e;for(let s=0;s<e;s++)this.ball.update(i),this.paddle.update(i)}loop(t){let e=(t-this.lastFrameTime)/1e3;if(this.lastFrameTime=t,this.state.update(e),l.update(),this.isBlocksBufferDirty){this.isBlocksBufferDirty=!1,this.blocksBuffer.clear();for(let i of this.blocks)i.render(this.blocksBuffer.context)}this.isDirty&&(this.canvas.clear(),this.canvas.context.save(),this.state.preRender(this.canvas.context),this.blocksBuffer.drawTo(0,0,this.canvas.context),this.ball.render(this.canvas.context),this.paddle.render(this.canvas.context),this.canvas.context.restore(),this.state.render(this.canvas.context),this.isDirty=!1),m.render(this.canvas.context),m.clear(),this.requestNextFrame()}};window._instance=new at;})();
