(()=>{var et=Math.pow;var d=(n,t,e)=>new Promise((i,s)=>{var r=c=>{try{h(e.next(c))}catch(m){s(m)}},o=c=>{try{h(e.throw(c))}catch(m){s(m)}},h=c=>c.done?i(c.value):Promise.resolve(c.value).then(r,o);h((e=e.apply(n,t)).next())});window.addLoadEventListener=function(n){let t=Function.oneshot(n);window.addEventListener("DOMContentLoaded",t),window.addEventListener("load",t),document.addEventListener("load",t),window.addEventListener("ready",t),setTimeout(t,1e3)};window.addVisibilityChangeEventListener=function(n){let t=["webkit","moz","ms",""],e=Function.debounce(()=>{n(window.isDocumentHidden())},50);t.forEach(i=>{document.addEventListener(`${i}visibilitychange`,e)}),document.onvisibilitychange=e};window.isMobile=function(){return window.matchMedia("(any-pointer: coarse)").matches};window.isDocumentHidden=function(){return["webkit","moz","ms",""].map(t=>t&&t.length>0?`${t}Hidden`:"hidden").map(t=>document[t]).reduce((t,e)=>t||e,!1)};window.getRefreshRate=function(){return new Promise((n,t)=>{let e=[60,75,100,120,144,165,240,360];setTimeout(()=>{requestAnimationFrame(i=>{requestAnimationFrame(s=>{let o=1e3/(s-i),h=e.reduce((c,m)=>Math.abs(m-o)<Math.abs(c-o)?m:c);n(h)})})},0)})};HTMLCanvasElement.prototype.screenshot=function(n="download.png"){let t=document.createElement("a");t.download=n,t.href=this.toDataURL("image/png;base64"),t.style.visibility="hidden",t.style.display="none",document.body.appendChild(t),setTimeout(()=>{t.click(),document.body.removeChild(t)},100)};String.prototype.toCamelCase=function(){return this.replace("--","").replace(/-./g,n=>n[1].toUpperCase()).trim()};Array.prototype.remove=function(n){let t=this.indexOf(n);return t!=-1?(this.splice(t,1),!0):!1};Array.prototype.appendArray=function(n){if(!!n)for(let t=0;t<n.length;t++)this.push(n[t])};Math.clamp=function(n,t,e){return Math.min(Math.max(n,t),e)};Math.average=function(...n){return n.reduce((t,e)=>t+e,0)/n.length};Math.distance=function(n,t,e,i){return Math.sqrt(Math.pow(e-n,2)+Math.pow(i-t,2))};Math.randomInt=function(n,t){return Math.floor(Math.random()*(t-n+1))+n};Math.lerp=function(n,t,e){return n+(t-n)*e};Math.oscilate=function(n,t,e,i){let s=2*Math.PI*t,r=i-e,h=(Math.sin(s*n)+1)/2;return e+h*r};CanvasRenderingContext2D.prototype.clear=function(){this.clearRect(0,0,this.canvas.width,this.canvas.height)};CanvasRenderingContext2D.prototype.line=function(n,t,e,i){this.beginPath(),this.moveTo(n,t),this.lineTo(e,i),this.stroke()};CanvasRenderingContext2D.prototype.fillTextCentered=function(n,t,e){let i=this.measureText(n);this.fillText(n,t-i.width/2,e)};Function.oneshot=function(n){let t=!1;return()=>{t||(t=!0,n())}};Function.timeout=function(n,t){let e=!1;return()=>{e||(e=!0,setTimeout(()=>{n(),e=!1},t))}};Function.debounce=function(n,t){let e=!1;return()=>{e||(e=!0,setTimeout(()=>{n(),e=!1},t))}};Promise.delay=function(n){return new Promise((t,e)=>{setTimeout(t,n)})};var a=class{constructor(t,e=void 0){this.x=t,e===void 0?this.y=t:this.y=e}dot(t){return this.x*t.x+this.y*t.y}add(t){return new a(this.x+t.x,this.y+t.y)}subtract(t){return new a(this.x-t.x,this.y-t.y)}multiply(t){return new a(this.x*t,this.y*t)}divide(t){return new a(this.x/t,this.y/t)}normalize(){let t=this.length;return new a(this.x/t,this.y/t)}clone(){return new a(this.x,this.y)}static distance(t,e){return Math.sqrt(et(t.x-e.x,2)+et(t.y-e.y,2))}static random(t){return new a(Math.random()*2-1,Math.random()*2-1).normalize().multiply(t)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static get zero(){return new a(0,0)}toString(){return`{ ${this.x}, ${this.y} }`}};var p=class{constructor(t,e,i,s){this.x=t;this.y=e;this.width=i;this.height=s}translate(t){return new p(this.x+t.x,this.y+t.y,this.width,this.height)}contains(t,e=void 0){if(t instanceof a&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y;if(t instanceof p&&e===void 0)return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height;if(typeof t=="number"&&typeof e=="number")return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height;throw new Error("Invalid arguments")}intersects(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}intersection(t){let e=Math.max(this.x,t.x),i=Math.max(this.y,t.y),s=Math.min(this.x+this.width,t.x+t.width)-e,r=Math.min(this.y+this.height,t.y+t.height)-i;return new p(e,i,s,r)}get size(){return new a(this.width,this.height)}get position(){return new a(this.x,this.y)}set position(t){this.x=t.x,this.y=t.y}get center(){return new a(this.x+this.width/2,this.y+this.height/2)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}clone(){return new p(this.x,this.y,this.width,this.height)}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}toString(){return`{ x: ${this.x}, y: ${this.y}, width: ${this.width}, height: ${this.height} }`}};var f=class{static logColoredText(t,e,i,...s){console[t].call(console,`%c${t.toUpperCase()} %c[${e}]`,`font-weight: bold; color: ${i};`,"font-weight: bold; color: gray",...s)}static info(t,...e){this.logColoredText("info",t,"turquoise",...e)}static warn(t,...e){this.logColoredText("warn",t,"yellow",...e)}static error(t,...e){this.logColoredText("error",t,"red",...e)}static debug(t,...e){}};var O=class{constructor(t=void 0){this.element=document.createElement("canvas");this.virtualWidth=0;this.virtualHeight=0;this.drawRatio=1;this.overrideRatio=void 0;t&&(this.element.id=t);let e=this.element.getContext("2d");if(!e)throw new Error("Could not get context of canvas");this.context=e,this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.element.oncontextmenu=()=>!1}get backingStoreRatio(){return this.overrideRatio||this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1}get devicePixelRation(){return this.overrideRatio||window.devicePixelRatio||1}getDrawRatio(t,e){return e/t}setSize(t,e){this.drawRatio=this.getDrawRatio(this.backingStoreRatio,this.devicePixelRation),this.backingStoreRatio!==this.devicePixelRation?(this.element.width=t*this.drawRatio,this.element.height=e*this.drawRatio,this.element.style.width=`${t}px`,this.element.style.minWidth=`${t}px`,this.element.style.height=`${e}px`,this.element.style.minHeight=`${e}px`):(this.element.width=t,this.element.height=e,this.element.style.width="",this.element.style.height=""),this.context.scale(this.drawRatio,this.drawRatio),this.virtualWidth=t,this.virtualHeight=e}clear(){this.context.clearRect(0,0,this.element.width,this.element.height)}drawTo(t,e,i){i.save(),i.scale(1/this.drawRatio,1/this.drawRatio),i.drawImage(this.element,t,e),i.restore()}attachToElement(t){t.appendChild(this.element)}get width(){return this.virtualWidth||this.element.width}get height(){return this.virtualHeight||this.element.height}get bounds(){return new p(0,0,this.width,this.height)}get size(){return{width:this.width,height:this.height}}};var u=class{static isKeyDown(...t){return t.some(e=>this.keys[e])}static isKeyJustPressed(...t){return t.some(e=>this.keysJustPressed[e])}static onKeyDown(t){this.keys[t.key]=!0,this.keysJustPressed[t.key]=!0,this.isDirty=!0,this.anyInput=!0}static onKeyUp(t){this.keys[t.key]=!1,delete this.keysJustPressed[t.key],this.isDirty=!0}static isMouseButtonDown(...t){return t.some(e=>this.mouseButtons[e])}static isMouseButtonJustPressed(...t){return t.some(e=>this.mouseButtonsJustPressed[e])}static isMouseButtonJustReleased(...t){return t.some(e=>this.mouseButtonsJustReleased[e])}static onMouseMove(t){var e,i,s,r;this.mouseDelta.x=t.movementX,this.mouseDelta.y=t.movementY,this.mouse.x=t.clientX-((i=(e=t.target)==null?void 0:e.offsetLeft)!=null?i:0),this.mouse.y=t.clientY-((r=(s=t.target)==null?void 0:s.offsetTop)!=null?r:0),this.isDirty=!0}static onMouseDown(t){this.mouseButtons[t.button]=!0,this.mouseButtonsJustPressed[t.button]=!0,this.isDirty=!0,this.anyInput=!0}static onMouseUp(t){this.mouseButtons[t.button]=!1,this.mouseButtonsJustReleased[t.button]=!0,this.isDirty=!0}static onPointerDown(t,e){console.log("Pointer down",e),this.mouseButtons[e.button]=!0,this.mouseButtonsJustPressed[e.button]=!0,t.setPointerCapture(e.pointerId),this.isDirty=!0,this.anyInput=!0}static onPointerUp(t,e){console.log("Pointer up",e),this.mouseButtons[e.button]=!1,this.mouseButtonsJustReleased[e.button]=!0,t.releasePointerCapture(e.pointerId),this.isDirty=!0}static setup(t){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.mouse.x=window.innerWidth/2,this.mouse.y=window.innerHeight/2,t.canvas.element.addEventListener("click",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousemove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("mousedown",this.onMouseDown.bind(this)),t.canvas.element.addEventListener("mouseup",this.onMouseUp.bind(this)),t.canvas.element.addEventListener("pointermove",this.onMouseMove.bind(this)),t.canvas.element.addEventListener("pointerdown",this.onPointerDown.bind(this,t.canvas.element)),t.canvas.element.addEventListener("pointerup",this.onPointerUp.bind(this,t.canvas.element))}static update(){this.keysJustPressed={},this.mouseButtonsJustPressed={},this.mouseButtonsJustReleased={},this.mouseDelta.x=0,this.mouseDelta.y=0,this.isDirty=!1,this.anyInput=!1}};u.isDirty=!1,u.anyInput=!1,u.keys={},u.keysJustPressed={},u.mouse=a.zero,u.mouseDelta=a.zero,u.mouseButtons={},u.mouseButtonsJustPressed={},u.mouseButtonsJustReleased={};var b=class{static alpha(t,e){let i=t;i.startsWith("#")&&(i=i.slice(1)),i.length===3&&(i=i.replace(/./g,"$&$&"));let s=Math.round(e*255).toString(16).padStart(2,"0");return`#${i}${s}`}static interpolate(t,e,i){let s=`0x${t.trim().slice(1)}`,r=`0x${e.trim().slice(1)}`;s.length<5&&(s=s.replace(/./g,"$&$&")),r.length<5&&(r=r.replace(/./g,"$&$&"));let o=parseInt(s,16),h=parseInt(r,16),c=o>>16,m=o>>8&255,w=o&255,P=h>>16,E=h>>8&255,x=h&255,C=Math.round(c+(P-c)*i),U=Math.round(m+(E-m)*i),N=Math.round(w+(x-w)*i);return`#${(16777216+(C<<16)+(U<<8)+N).toString(16).slice(1)}`}static isColorLight(t){let e=`0x${t.trim().slice(1)}`;e.length<5&&(e=e.replace(/./g,"$&$&"));let i=parseInt(e,16),s=i>>16,r=i>>8&255,o=i&255;return Math.sqrt(.299*(s*s)+.587*(r*r)+.114*(o*o))>127.5}};var it=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.strokeStyle=this.color,t.lineWidth=1,t.strokeRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},st=class{constructor(t,e){this.rect=t;this.color=e}render(t){t.fillStyle=this.color,t.fillRect(this.rect.x,this.rect.y,this.rect.width,this.rect.height)}},nt=class{constructor(t,e,i,s){this.start=t;this.end=e;this.color=i;this.thickness=s}render(t){t.strokeStyle=this.color,t.lineWidth=this.thickness,t.beginPath(),t.moveTo(this.start.x,this.start.y),t.lineTo(this.end.x,this.end.y),t.stroke()}},rt=class{constructor(t,e,i){this.center=t;this.radius=e;this.color=i}render(t){t.fillStyle=this.color,t.lineWidth=1,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,Math.PI*2),t.fill()}},ot=class{constructor(t,e,i,s){this.text=t;this.position=e;this.color=i;this.alignment=s}render(t){t.save(),t.fillStyle=this.color,t.font="12px Arial",t.textAlign=this.alignment,t.fillText(this.text,this.position.x,this.position.y),t.restore()}},at=class{constructor(t,e,i){this.origin=t;this.vector=e;this.color=i;this.ARROWHEAD_LENGTH=10;this.ARROWHEAD_ANGLE=Math.PI/6;this.MIN_LENGTH=1;this.MAX_LENGTH=100}render(t){let e=this.vector.length;if(e<this.MIN_LENGTH)return;e>this.MAX_LENGTH&&(this.vector=this.vector.normalize().multiply(this.MAX_LENGTH),e=this.MAX_LENGTH);let i=(e-this.MIN_LENGTH)/(this.MAX_LENGTH-this.MIN_LENGTH),s=b.alpha(this.color,i);t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1.5,t.lineCap="round",t.beginPath(),t.moveTo(this.origin.x,this.origin.y),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.stroke();let r=10,o=Math.PI/6,h=Math.atan2(this.vector.y,this.vector.x);t.beginPath(),t.moveTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.lineTo(this.origin.x+this.vector.x-r*Math.cos(h-o),this.origin.y+this.vector.y-r*Math.sin(h-o)),t.lineTo(this.origin.x+this.vector.x-r*Math.cos(h+o),this.origin.y+this.vector.y-r*Math.sin(h+o)),t.lineTo(this.origin.x+this.vector.x,this.origin.y+this.vector.y),t.fill()}},M=class{static render(t){}static clear(){}static rect(t,e="#fff"){}static outline(t,e="#fff"){}static line(t,e,i="#fff",s=1){}static circle(t,e,i="#fff"){}static text(t,e,i="#fff",s="left"){}static arrow(t,e,i="#fff"){}},g=M;g.list=[];var y=class{static set(t){this.current=t}static apply(){document.body.style.cursor=this.current}static reset(){this.current="default"}};y.current="default";var l=class{static get isDark(){return window.matchMedia("(prefers-color-scheme: dark)").matches}static setup(){return d(this,null,function*(){l.loadVariables(),l.observeChanges()})}static loadVariables(){let t=["--background","--foreground","--secondary","--container-background","--container-border","--container-shadow"];f.info("Theme",`Setting up theme, loading ${t.length} variables...`),console.groupCollapsed("Loading theme variables");let e=getComputedStyle(document.body);for(let i of t){let s=e.getPropertyValue(i),r=i.toString().toCamelCase();l[r]=s,console.log(`%c${r}`,`color: ${b.isColorLight(s)?"#212121":"#eee"}; background-color: ${s}`)}console.groupEnd()}static observeChanges(){let t=window.matchMedia("(prefers-color-scheme: dark)");t.addEventListener("change",()=>{f.info("Theme",`Changed theme to ${t.matches?"dark":"light"}`),l.loadVariables()})}};var T="'Pixelify Sans', sans-serif";var Kt=10*3,ht=440,dt=75,H=.2,mt=220,pt=110,bt=500,G=.5,ft=50,lt=0,gt=2.5,yt=5,vt=350;var I=class{static setup(){return d(this,null,function*(){this.context=new AudioContext,this.master=this.context.createGain(),this.master.connect(this.context.destination),this.master.gain.setValueAtTime(H,this.context.currentTime)})}static resume(){return d(this,null,function*(){if(this.context.state==="suspended"||this.context.state==="interrupted")yield this.context.resume();else if(this.context.state==="closed")return yield this.setup(),!0;return!1})}static play(t,e,i=0){return d(this,null,function*(){if(yield this.resume())return;let s=this.context.createGain();s.connect(this.master);let r=this.context.createStereoPanner();r.connect(s),r.pan.setValueAtTime(i,this.context.currentTime);let o=this.context.createOscillator();o.connect(r),o.type="square",o.frequency.setValueAtTime(t,this.context.currentTime);let h=.01,c=.1,m=.4,w=.1,P=this.context.currentTime,E=e/1e3,x=P+h*E,C=x+c*E,U=C+m*E,N=U+w*E;s.gain.setValueAtTime(0,P),s.gain.linearRampToValueAtTime(H,x),s.gain.linearRampToValueAtTime(.8*H,C),s.gain.linearRampToValueAtTime(.8*H,U),s.gain.linearRampToValueAtTime(0,N),o.addEventListener("ended",()=>{o.disconnect(),r.disconnect(),s.disconnect()}),o.start(P),o.stop(N)})}static playWithDurationVariance(t,e=0){return d(this,null,function*(){let i=dt*(1+Math.random()*.8-.4);this.play(t,i,e)})}};var z=class{static setup(){return d(this,null,function*(){let t=`${48}pt ${T}`;document.fonts.check(t)||(yield document.fonts.load(t))})}};var R={DIFFICULTY:1};var B=class{constructor(t){this.main=t;this.bounds=new p(0,0,10*2,10*2);this.velocity=new a(0,0);this.bounds.position=a.zero,this.velocity=a.zero,this.reset()}reset(){this.bounds.x=this.main.canvas.width/2-this.bounds.width/2,this.bounds.y=this.main.canvas.height/2-this.bounds.height/2+15*2,this.velocity=a.zero}bounceOffScreenEdges(){let t=this.main.canvas.size;this.bounds.x<0&&this.velocity.x<0?(this.bounds.x=0,this.velocity.x*=-1):this.bounds.x+this.bounds.width>t.width&&this.velocity.x>0&&(this.bounds.x=t.width-this.bounds.width,this.velocity.x*=-1),this.bounds.y<0&&this.velocity.y<0?(this.bounds.y=0,this.velocity.y*=-1):this.bounds.y+this.bounds.height>t.height&&this.velocity.y>0&&this.main.onBallBounceOffBottom()}bounceOffBlocks(){let t=this.main.blocks;for(let e=t.length-1;e>=0;e--){let i=t[e];if(this.bounds.intersects(i.bounds)){let s=Math.abs(this.bounds.bottom-i.bounds.y),r=Math.abs(this.bounds.y-i.bounds.bottom),o=Math.abs(this.bounds.right-i.bounds.x),h=Math.abs(this.bounds.x-i.bounds.right),c=Math.min(s,r,o,h);c===s||c===r?(this.velocity.y*=-1,this.bounds.y+=c===s?-10:10):(this.velocity.x*=-1,this.bounds.x+=c===o?-10:10),t.splice(e,1),this.main.onBallBounceOffBlock()}}}accelerateToRandomDirection(){this.velocity=new a(Math.random()<.5?-500:500,500)}bounceOffPaddle(){this.bounds.intersects(this.main.paddle.bounds)&&this.velocity.y>0&&(this.velocity.y*=-1,this.main.onBallBounceOffPaddle())}update(t){this.bounds.x+=this.velocity.x*R.DIFFICULTY*t,this.bounds.y+=this.velocity.y*R.DIFFICULTY*t,this.bounceOffScreenEdges(),this.bounceOffPaddle(),this.bounceOffBlocks()}render(t){t.beginPath(),this.main.isInPreparationTime?t.fillStyle=b.alpha(l.foreground,Math.sin(this.main.preparationTimer*(Math.PI*2)*1.2)*.25+.75):t.fillStyle=l.foreground,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var k=class{constructor(t){this.bounds=new p(0,0,100,20);this.score=0;this.bounds.position=new a(t.width/2-100/2,t.height-20-15)}render(t){t.fillStyle=l.foreground,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var q=class{constructor(t,e){this.start=t;this.end=e}intersects(t){let e=this.start.x,i=this.start.y,s=this.end.x,r=this.end.y,o=t.x,h=t.y,c=t.x+t.width,m=t.y+t.height,w=(e-s)*(h-m)-(i-r)*(o-c);if(w===0)return!1;let P=(e-o)*(h-m)-(i-h)*(o-c),E=(e-s)*(i-h)-(i-r)*(e-o),x=P/w,C=-E/w;return x>=0&&x<=1&&C>=0&&C<=1}intersection(t){let e=this.start.x,i=this.start.y,s=this.end.x,r=this.end.y,o=t.x,h=t.y,c=t.x+t.width,m=t.y+t.height,w=(e-s)*(h-m)-(i-r)*(o-c);if(w===0)return null;let P=(e-o)*(h-m)-(i-h)*(o-c),E=(e-s)*(i-h)-(i-r)*(e-o),x=P/w,C=-E/w;return x>=0&&x<=1&&C>=0&&C<=1?new a(e+x*(s-e),i+x*(r-i)):null}};var Y=class extends k{constructor(e){super(e.canvas.size);this.main=e;this.velocity=0;this.acceleration=0}moveTo(e,i,s=1){let r=i-this.bounds.x,o=135.34*R.DIFFICULTY*s;this.acceleration+=r*o,(Math.sign(this.velocity)!==Math.sign(this.acceleration)||Math.abs(this.velocity)<=Number.EPSILON)&&(this.acceleration*=.15*e)}moveToCenter(e){g.text("moveToCenter",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.canvas.width/2-this.bounds.width/2;this.moveTo(e,i)}chaseBall(e){g.text("chaseBall",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.ball.bounds.x,s=Math.abs(this.main.canvas.width-this.bounds.width),r=Math.abs(this.bounds.x-this.main.ball.bounds.x)/s;this.moveTo(e,i,r)}isThereAnyBlockBetweenPaddleAndBall(){let e=new q(this.bounds.center,this.main.ball.bounds.center.add(this.main.ball.velocity.multiply(.25)));for(let i of this.main.blocks)if(e.intersects(i.bounds))return!0;return!1}predictBallTrajectory(e){g.text("predictBallTrajectory",this.bounds.center.add(new a(0,-20)),"red","center");let i=this.main.ball.bounds.y-10,s=Math.abs(this.bounds.y-i)/(500*R.DIFFICULTY),r=this.main.ball.bounds.x+this.main.ball.velocity.x*s;r<0?r=Math.abs(r):r>this.main.canvas.width-this.main.ball.bounds.width&&(g.line(this.main.ball.bounds.center,new a(r,this.bounds.y),"magenta"),r=this.main.canvas.width-this.main.ball.bounds.width-(r-(this.main.canvas.width-this.main.ball.bounds.width))),g.line(this.main.ball.bounds.center,new a(r,this.bounds.y),"magenta"),r-=this.bounds.width/2,g.circle(new a(r,this.bounds.y),15,"cyan"),this.moveTo(e,r)}update(e){this.velocity+=this.acceleration*.5*e,Math.abs(this.velocity)>735.34&&(this.velocity=735.34*Math.sign(this.velocity)),this.bounds.x+=this.velocity*e,this.velocity+=this.acceleration*.5*e,this.velocity*=.9,this.acceleration=0,this.main.isInPreparationTime?this.moveToCenter(e):this.predictBallTrajectory(e)}};var L=class{setup(){return Promise.resolve()}preRender(t){}render(t){}};var K=class extends L{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return d(this,null,function*(){this.main.ball.velocity=a.zero,y.set("pointer")})}update(e){return d(this,null,function*(){this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,u.anyInput&&this.main.setState(new S(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(1-this.dimTimer,4),s=l.isDark?.15:.25;e.globalAlpha=s+i*(1-s),e.filter="blur(5px)"}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${T}`,e.fillStyle=l.foreground,e.shadowColor=l.containerShadow,e.shadowBlur=10*this.dimTimer,e.shadowOffsetY=2.5,e.fillTextCentered("You won!",this.width/2,this.height/2-48),e.font=`${48/2}pt ${T}`,e.fillStyle=b.alpha(l.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to restart",this.width/2,this.height/2),e.restore()}};var Z=class extends k{constructor(e){super(e.canvas.size);this.main=e}update(e){u.mouseDelta.x!==0?(this.bounds.x+=u.mouse.x-this.bounds.width/2-this.bounds.x,this.bounds.x<0?this.bounds.x=0:this.bounds.x+this.bounds.width>this.main.canvas.width&&(this.bounds.x=this.main.canvas.width-this.bounds.width)):(u.isKeyDown("ArrowLeft")&&(this.bounds.x-=135.34*e,this.bounds.x<0&&(this.bounds.x=0)),u.isKeyDown("ArrowRight")&&(this.bounds.x+=135.34*e,this.bounds.x+this.bounds.width>this.main.canvas.width&&(this.bounds.x=this.main.canvas.width-this.bounds.width)))}};var X=class extends L{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return d(this,null,function*(){y.set("pointer")})}update(e){return d(this,null,function*(){this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,u.anyInput&&this.main.setState(new S(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(1-this.dimTimer,4),s=l.isDark?.15:.25;e.globalAlpha=s+i*(1-s),e.filter=`blur(${i.toFixed(1)}px)`}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${T}`,e.fillStyle=l.foreground,e.shadowColor=l.containerShadow,e.shadowBlur=10*Math.pow(1-this.dimTimer,4),e.shadowOffsetY=2.5,e.fillTextCentered("Game over!",this.width/2,this.height/2-48),e.font=`${48/2}pt ${T}`,e.fillStyle=b.alpha(l.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to restart",this.width/2,this.height/2),e.restore()}};var S=class extends L{constructor(e){super();this.main=e}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return d(this,null,function*(){f.debug("StatePlay","Setting up..."),this.main.ball=new B(this.main),this.main.paddle=new Z(this.main),this.main.generateBlocks(),this.main.reset(!0),y.set("none")})}update(e){return d(this,null,function*(){this.main.blocks.length<=0?this.main.setState(new K(this.main)):this.main.lives<=0&&this.main.setState(new X(this.main)),this.main.updateEntities(e),this.invalidate()})}};var j=class extends L{constructor(e){super();this.main=e;this.dimTimer=0}get width(){return this.main.canvas.width}get height(){return this.main.canvas.height}invalidate(){this.main.invalidate()}setup(){return d(this,null,function*(){y.set("pointer"),this.main.ball=new B(this.main),this.main.paddle=new Y(this.main),this.main.generateBlocks()})}update(e){return d(this,null,function*(){this.main.blocks.length<=0&&(this.main.reset(!0),this.main.generateBlocks()),this.main.updateEntities(e),this.dimTimer>=1?this.dimTimer=1:this.dimTimer+=e,u.anyInput&&this.main.setState(new S(this.main)),this.invalidate()})}preRender(e){let i=Math.pow(this.dimTimer,4),s=l.isDark?.15:.25;e.globalAlpha=s*i,e.filter=`blur(${i.toFixed(1)}px)`}render(e){e.save(),e.globalAlpha=Math.pow(this.dimTimer,2),e.font=`${48}pt ${T}`,e.fillStyle=l.foreground,e.shadowColor=l.containerShadow,e.shadowBlur=10*Math.pow(this.dimTimer,4),e.shadowOffsetY=2.5,e.fillTextCentered("Breakout",this.width/2,this.height/2-48),e.font=`${48/2}pt ${T}`,e.fillStyle=b.alpha(l.foreground,Math.oscilate(Date.now()/1e3,.5,.25,1)),e.fillTextCentered("Press to start",this.width/2,this.height/2),e.restore()}};var Q=class{constructor(t,e,i){this.color=i;this.bounds=new p(t,e,60,22.5)}render(t){t.beginPath(),t.fillStyle=this.color,t.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}};var tt=class{constructor(t,e,i=G){this.position=t;this.velocity=e;this.duration=i}get opacity(){return this.duration/G*(l.isDark?.1:.4)}get size(){return(1-this.duration/G)*(gt-lt)+lt}update(t){this.position=this.position.add(this.velocity.multiply(t)),this.velocity=this.velocity.multiply(.95).add(a.random(500*t)),this.duration-=t,this.duration<=0&&(this.duration=0)}render(t){t.fillStyle=b.alpha(l.foreground,this.opacity),t.beginPath(),t.fillRect(this.position.x,this.position.y,this.size,this.size)}};var ut=class{constructor(){this.canvas=new O("canvas");this.isDirty=!0;this.blocksBuffer=new O("block-buffer");this.isBlocksBufferDirty=!0;this.handleAnimationFrameRequest=-1;this.lastFrameTime=performance.now();this.globalTimer=0;this.blocks=[];this.particles=[];this.state=new j(this);this.preparationTimer=3;this.lives=3;this.lastTimer=0;this.audioPitch=0;this.timeSinceLastHit=0;f.info("Main","Starting up..."),this.attachHooks()}attachHooks(){f.info("Main","Attaching hooks..."),window.addLoadEventListener(this.onLoad.bind(this)),window.addVisibilityChangeEventListener(this.onVisibilityChange.bind(this)),window.addEventListener("resize",this.onResize.bind(this)),u.setup(this)}get isInPreparationTime(){return this.preparationTimer>0}generateBlocks(){this.blocks=[];let t=Math.floor((this.canvas.width-15*2-60*2)/(60+15)),e=Math.floor((this.canvas.height/2-15*2-22.5)/(22.5+15)),i=this.canvas.width/2-t*(60+15)/2+15/2,s=this.canvas.height/2-e*(22.5+15);for(let r=0;r<e;r++)for(let o=0;o<t;o++){let h=o*(60+15)+i,c=r*(22.5+15)+s,m=`oklch(from hsl(${r/e*100} 50% 50%) l c h)`;this.blocks.push(new Q(h,c,m))}this.invalidateBlocksBuffer()}reset(t=!1){this.preparationTimer=3,t&&(this.lives=3),R.DIFFICULTY=1,this.ball.reset()}onLoad(){return d(this,null,function*(){f.debug("Main","Window loaded"),this.canvas.attachToElement(document.body),this.onResize();let t=[l.setup(),I.setup(),z.setup()];yield Promise.all(t),yield this.state.setup(),this.requestNextFrame()})}onVisibilityChange(t){f.info("Main",`Window visibility changed to ${t?"visible":"hidden"}`),t?(this.invalidate(),this.requestNextFrame()):this.handleAnimationFrameRequest!=-1&&cancelAnimationFrame(this.handleAnimationFrameRequest)}onResize(){f.debug("Main","Window resized");let t=16/10,e=1200,i=e/t,s=this.canvas.size,r=window.innerWidth-15*4,o=window.innerHeight-15*4;o>i&&(o=i),r>e&&(r=e),r/o>t?r=o*t:o=r/t,this.canvas.setSize(r,o),this.blocksBuffer.setSize(r,o),this.invalidate(),this.invalidateBlocksBuffer()}onBallBounceOffPaddle(){this.addParticleExplosion(),I.playWithDurationVariance(ht),R.DIFFICULTY*=1.0075}onBallBounceOffBlock(){this.addParticleExplosion(),this.timeSinceLastHit=performance.now(),this.audioPitch+=.25;let t=Math.min(1,Math.max(-1,(this.ball.bounds.center.x-screen.width/2)/(screen.width/2))),e=mt*(1+this.audioPitch);I.playWithDurationVariance(e,t),R.DIFFICULTY*=1.0075,this.invalidateBlocksBuffer()}onBallBounceOffBottom(){this.lives--,this.reset(),I.playWithDurationVariance(ht)}setState(t){this.state=t,this.state.setup(),y.apply(),this.invalidate()}invalidate(){this.isDirty=!0}invalidateBlocksBuffer(){this.isBlocksBufferDirty=!0,this.isDirty=!0}requestNextFrame(){this.handleAnimationFrameRequest=requestAnimationFrame(this.loop.bind(this))}addParticleExplosion(){for(let t=0;t<ft;t++){let e=a.random(yt).add(this.ball.bounds.center),i=a.random(vt).add(this.ball.velocity.multiply(.25));this.particles.push(new tt(e,i))}}updateTimers(t,e){if(t-this.timeSinceLastHit>bt&&(this.audioPitch=0),this.ball.velocity.length===0){if(this.preparationTimer<=0?this.ball.accelerateToRandomDirection():this.preparationTimer-=e,Math.floor(this.preparationTimer)!==this.lastTimer){this.lastTimer=Math.floor(this.preparationTimer);let i=pt*(3-this.preparationTimer+1);I.playWithDurationVariance(i)}g.text(this.preparationTimer.toFixed(2),this.ball.bounds.center.add(new a(0,10*4)),"red","center")}}updateEntities(t){this.updateTimers(performance.now(),t);let e=4,i=t/e;for(let s=0;s<e;s++)this.ball.update(i),this.paddle.update(i);for(let s=this.particles.length-1;s>=0;s--)this.invalidate(),this.particles[s].update(t),this.particles[s].duration<=0&&this.particles.splice(s,1)}renderEntities(){this.canvas.clear(),this.canvas.context.save(),this.state.preRender(this.canvas.context),this.blocksBuffer.drawTo(0,0,this.canvas.context),this.ball.render(this.canvas.context),this.paddle.render(this.canvas.context),this.canvas.context.restore();for(let t of this.particles)t.render(this.canvas.context);this.state.render(this.canvas.context),this.isDirty=!1}loop(t){let e=(t-this.lastFrameTime)/1e3;if(this.lastFrameTime=t,this.state.update(e),u.update(),this.isBlocksBufferDirty){this.isBlocksBufferDirty=!1,this.blocksBuffer.clear();for(let i of this.blocks)i.render(this.blocksBuffer.context)}this.isDirty&&this.renderEntities(),g.render(this.canvas.context),g.clear(),this.requestNextFrame()}};window._instance=new ut;})();
